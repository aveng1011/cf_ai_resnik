<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resnik Voice Assistant - NASA SUITS</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide icons as inline SVG components
        const Mic = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" x2="12" y1="19" y2="22"/>
            </svg>
        );

        const MicOff = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="2" x2="22" y1="2" y2="22"/>
                <path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"/>
                <path d="M5 10v2a7 7 0 0 0 12 5"/>
                <path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"/>
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12"/>
                <line x1="12" x2="12" y1="19" y2="22"/>
            </svg>
        );

        const Send = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" x2="11" y1="2" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
        );

        const Radio = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="2"/>
                <path d="M4.93 19.07a10 10 0 0 1 0-14.14"/>
                <path d="M7.76 16.24a6 6 0 0 1 0-8.49"/>
                <path d="M16.24 7.76a6 6 0 0 1 0 8.49"/>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
            </svg>
        );

        const Gauge = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m12 14 4-4"/>
                <path d="M3.34 19a10 10 0 1 1 17.32 0"/>
            </svg>
        );

        const MapPin = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        );

        const ResnikVoiceAssistant = () => {
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [messages, setMessages] = useState([
                { role: 'assistant', content: 'Resnik initialized. Ready for mission support.' }
            ]);
            const [telemetry, setTelemetry] = useState({
                primaryO2: 3200,
                secondaryO2: 3400,
                suitPressure: 4.3,
                heartRate: 72,
                temperature: 21.5,
                position: { lat: -23.4, lon: 12.8 },
                ltvDistance: 127,
                ltvBearing: 45
            });
            const [isProcessing, setIsProcessing] = useState(false);
            const [workerUrl, setWorkerUrl] = useState('http://localhost:8787');
            const recognitionRef = useRef(null);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                // Initialize speech recognition
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;
                    recognitionRef.current.lang = 'en-US';

                    recognitionRef.current.onresult = (event) => {
                        const text = event.results[0][0].transcript;
                        setTranscript(text);
                        handleVoiceCommand(text);
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsListening(false);
                    };

                    recognitionRef.current.onend = () => {
                        setIsListening(false);
                    };
                }

                // Simulate telemetry updates
                const interval = setInterval(() => {
                    setTelemetry(prev => ({
                        ...prev,
                        primaryO2: Math.max(2800, prev.primaryO2 - Math.random() * 10),
                        secondaryO2: Math.max(3000, prev.secondaryO2 - Math.random() * 8),
                        suitPressure: 4.3 + (Math.random() - 0.5) * 0.2,
                        heartRate: 70 + Math.floor((Math.random() - 0.5) * 10),
                        temperature: 21 + (Math.random() - 0.5) * 1
                    }));
                }, 5000);

                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const toggleListening = () => {
                if (!recognitionRef.current) {
                    alert('Speech recognition not supported. Please use Chrome or Edge.');
                    return;
                }

                if (isListening) {
                    recognitionRef.current.stop();
                    setIsListening(false);
                } else {
                    setTranscript('');
                    recognitionRef.current.start();
                    setIsListening(true);
                }
            };

            const handleVoiceCommand = async (text) => {
                const userMessage = { role: 'user', content: text };
                setMessages(prev => [...prev, userMessage]);
                setIsProcessing(true);

                try {
                    // Call Cloudflare Worker API
                    const response = await fetch(`${workerUrl}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: text,
                            conversationHistory: messages,
                            telemetry: telemetry
                        })
                    });

                    if (!response.ok) {
                        throw new Error('API request failed');
                    }

                    const data = await response.json();
                    const assistantMessage = { role: 'assistant', content: data.response };
                    setMessages(prev => [...prev, assistantMessage]);
                    speakResponse(data.response);

                    // Handle emergency alerts
                    if (data.emergency || data.telemetryAlert) {
                        console.warn('EMERGENCY CONDITION DETECTED');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    const errorMessage = { 
                        role: 'assistant', 
                        content: 'Error communicating with mission control. Please try again.' 
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsProcessing(false);
                }
            };

            const speakResponse = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    window.speechSynthesis.speak(utterance);
                }
            };

            const handleTextSubmit = () => {
                if (transcript.trim()) {
                    handleVoiceCommand(transcript);
                    setTranscript('');
                }
            };

            const getTelemetryStatus = (value, min, max) => {
                if (value < min) return 'text-red-400';
                if (value > max) return 'text-yellow-400';
                return 'text-green-400';
            };

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-gray-800 border border-cyan-500 rounded-lg p-4 mb-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Radio className="w-8 h-8 text-cyan-400" />
                                    <div>
                                        <h1 className="text-2xl font-bold text-cyan-400">RESNIK</h1>
                                        <p className="text-xs text-gray-400">AI Mission Assistant - EVA Support System</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 px-3 py-1 bg-green-900/30 border border-green-500 rounded">
                                    <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse" />
                                    <span className="text-xs font-mono text-green-400">ACTIVE</span>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div className="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                <h2 className="text-lg font-semibold text-cyan-400 mb-3 flex items-center gap-2">
                                    <Gauge className="w-5 h-5" />
                                    Telemetry
                                </h2>
                                <div className="space-y-3">
                                    <div className="bg-gray-900 p-3 rounded">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-xs text-gray-400">Primary O₂</span>
                                            <span className={`text-sm font-mono font-bold ${getTelemetryStatus(telemetry.primaryO2, 3000, 3500)}`}>
                                                {Math.round(telemetry.primaryO2)} psi
                                            </span>
                                        </div>
                                        <div className="w-full bg-gray-700 rounded-full h-2">
                                            <div 
                                                className="bg-green-500 h-2 rounded-full transition-all"
                                                style={{ width: `${(telemetry.primaryO2 / 3500) * 100}%` }}
                                            />
                                        </div>
                                    </div>

                                    <div className="bg-gray-900 p-3 rounded">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-xs text-gray-400">Secondary O₂</span>
                                            <span className={`text-sm font-mono font-bold ${getTelemetryStatus(telemetry.secondaryO2, 3000, 3500)}`}>
                                                {Math.round(telemetry.secondaryO2)} psi
                                            </span>
                                        </div>
                                        <div className="w-full bg-gray-700 rounded-full h-2">
                                            <div 
                                                className="bg-green-500 h-2 rounded-full transition-all"
                                                style={{ width: `${(telemetry.secondaryO2 / 3500) * 100}%` }}
                                            />
                                        </div>
                                    </div>

                                    <div className="bg-gray-900 p-3 rounded">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs text-gray-400">Suit Pressure</span>
                                            <span className="text-sm font-mono font-bold text-green-400">
                                                {telemetry.suitPressure.toFixed(1)} psi
                                            </span>
                                        </div>
                                    </div>

                                    <div className="bg-gray-900 p-3 rounded">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs text-gray-400">Heart Rate</span>
                                            <span className="text-sm font-mono font-bold text-green-400">
                                                {telemetry.heartRate} bpm
                                            </span>
                                        </div>
                                    </div>

                                    <div className="bg-gray-900 p-3 rounded">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs text-gray-400">Temperature</span>
                                            <span className="text-sm font-mono font-bold text-green-400">
                                                {telemetry.temperature.toFixed(1)}°C
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-4 p-3 bg-blue-900/20 border border-blue-500 rounded">
                                    <div className="flex items-start gap-2">
                                        <MapPin className="w-4 h-4 text-blue-400 mt-0.5" />
                                        <div className="text-xs">
                                            <div className="text-blue-400 font-semibold">Position</div>
                                            <div className="text-gray-400 font-mono">{telemetry.position.lat}°S, {telemetry.position.lon}°W</div>
                                            <div className="text-gray-400">LTV: {telemetry.ltvDistance}m, {telemetry.ltvBearing}°</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2 bg-gray-800 border border-gray-700 rounded-lg p-4 flex flex-col h-[600px]">
                                <h2 className="text-lg font-semibold text-cyan-400 mb-3">Mission Communication</h2>
                                
                                <div className="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] rounded-lg p-3 ${
                                                msg.role === 'user' 
                                                    ? 'bg-cyan-600 text-white' 
                                                    : 'bg-gray-700 text-gray-100'
                                            }`}>
                                                <div className="text-xs font-semibold mb-1 opacity-70">
                                                    {msg.role === 'user' ? 'EV-1' : 'RESNIK'}
                                                </div>
                                                <div className="text-sm">{msg.content}</div>
                                            </div>
                                        </div>
                                    ))}
                                    {isProcessing && (
                                        <div className="flex justify-start">
                                            <div className="bg-gray-700 rounded-lg p-3">
                                                <div className="flex gap-1">
                                                    <div className="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" />
                                                    <div className="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }} />
                                                    <div className="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }} />
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                <div className="border-t border-gray-700 pt-4">
                                    <div className="flex gap-2 mb-3">
                                        <input
                                            type="text"
                                            value={transcript}
                                            onChange={(e) => setTranscript(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && handleTextSubmit()}
                                            placeholder="Type your message or use voice command..."
                                            className="flex-1 bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-cyan-500"
                                            disabled={isProcessing}
                                        />
                                        <button
                                            onClick={handleTextSubmit}
                                            disabled={!transcript.trim() || isProcessing}
                                            className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded transition-colors"
                                        >
                                            <Send className="w-4 h-4" />
                                        </button>
                                    </div>

                                    <button
                                        onClick={toggleListening}
                                        disabled={isProcessing}
                                        className={`w-full py-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 ${
                                            isListening 
                                                ? 'bg-red-600 hover:bg-red-700 animate-pulse' 
                                                : 'bg-cyan-600 hover:bg-cyan-700'
                                        } disabled:bg-gray-600 disabled:cursor-not-allowed`}
                                    >
                                        {isListening ? (
                                            <>
                                                <MicOff className="w-5 h-5" />
                                                LISTENING... (Click to stop)
                                            </>
                                        ) : (
                                            <>
                                                <Mic className="w-5 h-5" />
                                                ACTIVATE VOICE COMMAND
                                            </>
                                        )}
                                    </button>

                                    <div className="mt-3 text-xs text-gray-400 space-y-1">
                                        <div className="font-semibold text-cyan-400">Try saying:</div>
                                        <div>• "What's my oxygen status?"</div>
                                        <div>• "Check my vitals"</div>
                                        <div>• "What's the distance to LTV?"</div>
                                        <div>• "Show me the optimal route"</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-4 bg-gray-800 border border-gray-700 rounded-lg p-4">
                            <h3 className="text-sm font-semibold text-gray-400 mb-2">QUICK COMMANDS</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                {['System status', 'O2 levels', 'Route to LTV', 'Emergency protocol'].map((cmd) => (
                                    <button
                                        key={cmd}
                                        onClick={() => handleVoiceCommand(cmd)}
                                        disabled={isProcessing}
                                        className="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs transition-colors disabled:opacity-50"
                                    >
                                        {cmd}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ResnikVoiceAssistant />, document.getElementById('root'));
    </script>
</body>
</html>
